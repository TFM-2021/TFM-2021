library(shiny)
library(readr)
library(tidyverse)


arbol <- read_rds("arbol_intensidad_terremotos.rds")

matriz_costes <- read_delim("matriz_costes.csv", 
                            ";", escape_double = FALSE, trim_ws = TRUE)



# Define UI ----
ui <- fluidPage(
  titlePanel("CALCULADORA TERREMOTOS"),
  sidebarLayout(
    sidebarPanel("sidebar panel",
                 
                 numericInput("magnitud",
                              label = "Magnitud Terremoto",
                              value = 0,
                              max = 10,
                              step = 0.1),
                 
                 numericInput("profundidad",
                              label = "Profundadidad Terremoto",
                              value = 1,
                              max = 300,
                              step = 0.1),
                 
                 
                 numericInput("m2_ladrillo",
                              label = "Metros cuadrados ladrillo",
                              value = 1,
                              step = 10000),
                 
                 numericInput("m2_hormigon",
                              label = "Metros cuadrados hormig贸n",
                              value = 1,
                              step = 10000),
                 
                 numericInput("m2_coste",
                              label = "Coste metros cuadrados",
                              value = 1,
                              step = 10),
                 selectInput("intensidad_terremoto",
                             label = "Elija la intensidad",
                             choices = unique(matriz_costes$Terremoto))
                 
                 
                 
                 
                 ),
    mainPanel(textOutput("plot_arr"),
              textOutput("coste_terremoto"))
  )
  
  
)

# Define server logic ----
server <- function(input, output) {
  
  input_reactivo <- reactive({ 
    
  mag <- (input$magnitud - 2.850961)/0.9478287
  
  prof_km <- log(input$profundidad)
  
  input_table <- tibble("prof_km"=prof_km,"inten"=as.factor("VII"),
                        "mag"=mag,
                        "placa_tectonica"=as.factor(0))
  
  as.character(predict(arbol, input_table, type = "class"))
  
  })
  
  

  
  output$plot_arr <- renderText({ 
    paste0("INTENSIDAD PREVISTA POR EL MODELO: ", input_reactivo()) })
  
  
  input_costes <- reactive({
    
    
    
    
    millones_m2_ladrillo <- input$m2_ladrillo
    millones_m2_hormigon <- input$m2_hormigon
    precio_m2 <- input$m2_coste
    
    matriz_filtrada <- matriz_costes %>%
      filter(Terremoto ==  input$intensidad_terremoto)
    
    
    coste_ladrillos <- matriz_filtrada$`Ladrillo y madera` * millones_m2_ladrillo*precio_m2 * matriz_filtrada$`Percentages of repair to reposition`
    coste_hormig贸n <- matriz_filtrada$`Hormig贸n armado` * millones_m2_hormigon*precio_m2 * matriz_filtrada$`Percentages of repair to reposition`
    
    
   coste_ladrillos + coste_hormig贸n
    
    
    
    
  })
  
  
  output$coste_terremoto <- renderText({ 
    paste0("TOTAL DE COSTE DEL TERREMOTO: ",input_costes()) })
  
}




# Run the app ----
shinyApp(ui = ui, server = server)






